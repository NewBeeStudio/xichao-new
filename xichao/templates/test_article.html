{% extends "layout.html" %}

<!--css file used-->
{% block css %}
<!--e.g. <link href="{{ url_for('static', filename='css/register.css') }}" rel='stylesheet' type='text/css'/> -->
	<link rel="stylesheet" type="text/css" href="/static/css/article.css" />
	<link rel="stylesheet" type="text/css" href="/static/css/button.css" />
{% endblock %}

<!--content-->
{% block content %}
	<p id="p_title_1">&nbsp;首页&nbsp;>&nbsp;文章&nbsp;>书评&nbsp;>&nbsp;</p>
	<p id="p_title_2">文章详情</p>
	<input type="hidden" id="article_id" value="{{article.article_id}}">
	<div id="article_title">
		<p id="p_article_title">{{article.title}}</p>
	</div>
	<div id="article_content">
		<p id="p_num_xichao">曦潮币</p>
		<p id="p_num_xichao_content">{{article.coins}}</p>
		<p id="p_article_author_1">作者</p>
		<p id="p_article_author_2">{{author.nick}}</p>
		<p id="p_article_time_1">发表时间</p>
		<p id="p_article_time_2">{{article.time}}</p>
		<div id="p_article_content" style="display:None;"><!--该div用于寄存文章内容-->
			{{article.content}}
		</div>
	</div>
	<div id="article_content_html"><!--该div用于显示文章内容-->
	</div>
	<div id="share">
		<p id="p_share">分享</p>
		<img src="/static/images/share_sinaweibo.png"/>
		<img src="/static/images/share_qzone.png"/>
		<img src="/static/images/share_renren.png"/>
		<img src="/static/images/share_rss.png"/>
	</div>
	<div id="read">
		<p id="p_read">阅读</p>
		<p id="p_read_content">({{article.read_num}})</p>
		<p id="p_review">评论</p>
		<p id="p_review_content">({{article.comment_num}})</p>
		<p id="p_collection">收藏</p>
		<p id="p_collection_content">({{article.favor}})</p>

		<button id="pay_button">打赏作者</button>		
	</div>
	<hr>
	<div id="book_info">
		<div id="pic_book">
			<img style="width:225px;height:205px;" src="{{book.picture}}" />
		</div>
		<div id="p_book_info">
			<p id="name">书名</p>
			<p id="author">作者</p>
			<p id="publish">出版社</p>
			<p id="date">出版年份</p>
			<p id="page">页数</p>
			<p id="price">定价</p>
			<p id="ISBN">ＩＳＢＮ</p>
		</div>
		<div id="p_book_info_content">
			<p id="name_content">{{book.title}}</p>
			<p id="author_content">{{book.author}}</p>
			<p id="publish_content">{{book.press}}</p>
			<p id="date_content">{{book.press_time}}</p>
			<p id="page_content">{{book.page_num}}</p>
			<p id="price_content">{{book.price}}</p>
			<p id="ISBN_content">{{book.ISBN}}</p>
		</div>
	</div>
	<hr>
	<div id="publish_review">
		<p id="p_publish_review">发表评论 :</p>
		<img id="user_pic_1" src="{{avatar}}">
		<iframe id="input_publish_review"></iframe>
		<p id="p_user_name">{{nick}}</p>
		<button  class="myButton" id="comment_reset_button">取消</button>
		<button  class="myButton" id="comment_publish_button">确认</button>
	</div>
	<hr>
	<div id="list_review">
		<p id="p_list_review">评论列表</p>

		<div id="comment_new">
			
		</div>

		{% if comments!=None %}
			{% for comment in comments %}
				<div class="comment">
					<!--{{comment[0]}}comment对象实例，不用显示，需要显示的是属性，比如content，time-->
					<img class="user_pic_2" src="{{comment[2]}}">
					<div class="line"></div>
					<p class="p_review_author">{{comment[1]}}</p>
					<div class="comment_content">{{comment[0].content}}</div>
					<p class="p_publish_time">{{comment[0].time}}</p>
					<!--{{comment[0].content}}<!--comment的内容-->
					<!--{{comment[0].time}}<!--comment的时间-->
					<!--{{comment[1]}}该条comment的评论人-->
					<!--{{comment[2]}}该条comment的评论人头像链接,可以不用显示，应该作为img标签的src属性，如下-->
				</div>
				<!--<hr>-->
			{% endfor %}
		{% endif %}
	</div>
{% endblock %}


<!--js file used-->
{% block js %}
<script type="text/javascript" charset="utf-8" src="{{ url_for('static', filename='js/jquery-1.8.0.min.js') }}"></script>
<script src="{{ url_for('static', filename='layer-v1.8.5/layer/layer.min.js') }}"></script>


<script type="text/javascript">
	$(function(){
		$d = $("#input_publish_review")[0].contentWindow.document;
		$d.designMode="on";
    	$d.contentEditable= true;
    	$d.open();
    	$d.close();
	});
</script>  


<!--获取评论内容，更新数据库，返回评论时间-->
<script type="text/javascript">
$("#comment_publish_button").click(function(){
	//val_content=$("#input_publish_review").text();
	val_content = $('#input_publish_review').contents().find('body').html();
	$('#input_publish_review').contents().find('body').empty();
	$.post('http://127.0.0.1:5000/article/comment',
		{
			content:val_content,
			article_id:{{article.article_id}},
			to_user_id:{{article.user_id}}
		},
		function(data){
			$("#comment_publish_time").text(data);
			layer.msg("评论成功",1,1);
			/*var time = data;
			var nick = "{{nick}}";
			var avatar = "{{avatar}}";
			var content = val_content;
			var newdiv = $('<div><p>heelo</p></div>');*/
			/*$('#comment_new').prepend('<div><p>hello</p></div>');*/
			/*$('#comment_new').prepend('<div class="comment">'+
				'<img class="user_pic_2" src="{{avatar}}">'+
				'<div class="line"></div>'+
				'<p class="p_review_author">{{nick}}</p>'+
				'<div class="comment_content">'+val_content+'</div>'+
				'<p class="p_publish_time">'+data+'</p></div><hr>');*/
			add_commit(data, val_content);
		});
});

$("#comment_reset_button").click(function(){
	$('#input_publish_review').contents().find('body').empty();
});
</script>

<script type="text/javascript">
$(document).ready(function(){
	val=$("#p_article_content").text();
	$("#article_content_html").html(val);
})
</script>

<script type="text/javascript">
	$(document).ready(function(){
		url = "{{ url_for('pay_author', article_id=article.article_id) }}"
		$("#pay_button").click(function(){
			$.layer({
				type: 2,
				title: ['打赏曦潮币'],
				shade: [0.65, '#000'],
				shadeClose: true,
				closeBtn: false,
				border: [2, 1, '#D9AE48'],
				area: ['760px', '258px'],
				iframe: {src: url},
			});
		});
	});
</script>

</script>

<script type="text/javascript">
function update_xichao(data){
	var tmp = parseInt(data) + parseInt($('#p_num_xichao_content').text());
  	$('#p_num_xichao_content').html(tmp);
}
</script>

<script type="text/javascript">
function get_author_id() {
	return {{ author.user_id }};
}

function get_article_id() {
	return {{ article.article_id }};
}

function get_user_id() {
	return {{ article.user_id }};
}

function add_commit(data, val_content) {
	$('#comment_new').prepend('<div class="comment">'+
				'<img class="user_pic_2" src="{{avatar}}">'+
				'<div class="line"></div>'+
				'<p class="p_review_author">{{nick}}</p>'+
				'<div class="comment_content">'+val_content+'</div>'+
				'<p class="p_publish_time">'+data+'</p></div><hr>');
}
</script>
{% endblock %}
