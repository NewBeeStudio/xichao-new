{% extends "layout.html" %}

{% block css %}
<link href="{{ url_for('static', filename='css/register.css') }}" rel='stylesheet' type='text/css'/>
{% endblock %}

{% block content %}
    <!--当前位置-->
    <div class="current-position">

    </div>
    <!--注册表单-->
    {% from "test_formhelpers.html" import render_register %}
    <form method="post" action="/register" accept-charset="utf-8" enctype="multipart/form-data">
        <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
        <dl>
        {{ render_register(form.email, 0) }}
        {{ render_register(form.nick, 1) }}
        {{ render_register(form.password, 2) }}
        {{ render_register(form.confirm, 3) }}
        {{ render_register(form.photo, 4) }}
        {% if photo_error != None%}
            {{ photo_error }}
        {% endif %}
        </dl>
      <input class="register-button" type="reset" value="取消">
      <input class="register-button" type="submit" value="提交">
    </form>
{% endblock %}

{% block js %}
<script type="text/javascript">
    $(document).ready(function(){

      $(".register-form-value").each(function(){
            var warning = $(this).next().text().replace(/(^\s*)|(\s*$)/g, ""); //获取warning区内容，去除空白字符

            //有warning则输入框变色
            if(warning.length > 0)
              $(this).children().first().addClass("input-warning");
            else
              $(this).children().first().removeClass("input-warning");
      });
      
      
      /************************************************************/
      /*input ajax*/
      /************************************************************/
      $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

      $(".register-form-value input").change(function(){
      var index = parseInt($(this).parent().attr("data-index")); //changed line number
      // alert(index);
      var info = new Array();
      $(".register-form-value input").each(function(){
        info[parseInt($(this).parent().attr("data-index"))] = $(this).val();
      });
      // alert(info);
      $.getJSON($SCRIPT_ROOT + '/ajax_register', {
        email: info[0],
        nick: info[1],
        password: info[2],
        confirm: info[3]}, function(data){
        $(".register-form-value").each(function(){
            var cur_index = parseInt($(this).attr("data-index"))
            var cur_val = $(this).children().first().val() //input框是否有内容

            $(this).next().text("");
            if(cur_index <= index){ //当前光标位置在其之下，则显示警告内容
              if(cur_index == 0)
                $(this).next().text(data.email);
              else if(cur_index == 1)
                $(this).next().text(data.nick);
              else if(cur_index == 2)
                $(this).next().text(data.password);
              else if(cur_index == 3)
                $(this).next().text(data.confirm);
            }
            else{
              $(this).next().text("");
            }

            //input框变色
            if($(this).next().text() != "" && cur_index <= index){
              $(this).children().first().removeClass("input-ok");
              $(this).children().first().addClass("input-warning");
            }
            else if($(this).next().text() == "" && cur_index <= index){
              $(this).children().first().removeClass("input-warning");
              $(this).children().first().addClass("input-ok");
            }
            else{
              $(this).children().first().removeClass("input-warning");
              $(this).children().first().removeClass("input-ok");
            }
        });
      });
    });
});
</script>
{% endblock %}