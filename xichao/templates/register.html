{% extends "layout.html" %}

{% block css %}
<link href="{{ url_for('static', filename='css/register.css') }}" rel='stylesheet' type='text/css'/>
{% endblock %}

{% block content %}
    <!--当前位置-->
    <div class="current-position">
        <p style="font-size: 21px; font-family: 微软雅黑;">注册</p>
    </div>
    <!--注册表单-->
    {% from "test_formhelpers.html" import render_register %}
    <form method="post" action="/register" accept-charset="utf-8" enctype="multipart/form-data">
        <input name=_csrf_token type=hidden value="{{ csrf_token() }}">
        <dl>
        {{ render_register(form.email, 0) }}
        {{ render_register(form.nick, 1) }}
        {{ render_register(form.password, 2) }}
        {{ render_register(form.confirm, 3) }}
        <div id="register-avatar">
          <div class="register-form-field register-label">
            <label class>头像：</label>
          </div>

          <div>
            <img id="avatar_user" src="{{url_for('uploaded_avatar',filename='default.jpg')}}">
            <input type="button" id="avatar_button" value="上传头像">
          </div>

          <div id="default-avatar-gallery">
            <input name="avatar" type="hidden" value="{{url_for('uploaded_avatar',filename='default.jpg')}}">
            <!-- <div id="label-default-avatar">
              默认头像
            </div> -->
            <img class="default_avatar" id="avatar_default_1" src="{{url_for('uploaded_avatar',filename='default1.jpg')}}">
            <img class="default_avatar" id="avatar_default_2" src="{{url_for('uploaded_avatar',filename='default2.jpg')}}">
            <img class="default_avatar" id="avatar_default_3" src="{{url_for('uploaded_avatar',filename='default3.jpg')}}">
            <img class="default_avatar" id="avatar_default_4" src="{{url_for('uploaded_avatar',filename='default4.jpg')}}">
          </div>
        </div>
        </dl>
      <div class="clear">
        <input class="register-button" type="reset" value="取消">
        <input class="register-button" id="registration" type="submit" value="提交">
      </div>
    </form>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='layer-v1.8.5/layer/layer.min.js') }}"></script>
<script type="text/javascript">
  $(document).ready(function()
  {
    /************************************************************/
    /*图片强调*/
    /************************************************************/
    $(".default_avatar").click(function()
    {
      $(".default_avatar").each(function()
      {
        $(this).css("border","2px solid #ffffff");
      });

      $(this).css("border","2px solid #0000ff");
    });

    /************************************************************/
    /*显示注册错误信息*/
    /************************************************************/
    $(".register-error").each(function()
    {
      var warning = $(this).text().replace(/(^\s*)|(\s*$)/, ""); //获取warning区内容，去除空白字符

      if(warning.length > 0)
        $(this).css("display", "block");
      else
        $(this).css("display", "none");
    });
      
      
    /************************************************************/
    /*AJAX交互*/
    /************************************************************/
    $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

    $(".register-form-value input").change(function()
    {
      var index = parseInt($(this).parent().attr("data-index")); //changed line number
          
      var info = new Array();
      $(".register-form-value input").each(function()
      {
        info[parseInt($(this).parent().attr("data-index"))] = $(this).val();
      });
          
      $.getJSON($SCRIPT_ROOT + '/ajax_register', {
      email: info[0],
      nick: info[1],
      password: info[2],
      confirm: info[3]}, function(data)
      {
        $(".register-error").each(function()
        {
          var cur_index = parseInt($(this).attr("data-index"));
          $(this).text(""); 
          $(this).css("display", "none"); //先初始化

          if(cur_index <= index){ 
            //当前光标位置在其之下，则显示警告内容
            if(cur_index == 0 && data.email != ""){
              $(this).text(data.email);
              $(this).css("display", "block");
            }
            else if(cur_index == 1 && data.nick != ""){
              $(this).text(data.nick);
              $(this).css("display", "block");
            }
            else if(cur_index == 2 && data.password != ""){
              $(this).text(data.password);
              $(this).css("display", "block");
            }
                
            else if(cur_index == 3 && data.confirm != ""){
              $(this).text(data.confirm);
              $(this).css("display", "block");
            }  
          }
        });
      });
    });
  });
</script>

<script type="text/javascript">
  $(document).ready(function(){
    $("#avatar_button").click(function(){
      $.layer({
        type: 2,
        title: [
            '上传头像', 
            'background:#2B2E37; height:40px; color:#fff; border:none;' //自定义标题样式
        ],
        shadeClose: true,
        closeBtn: false, 
        border:[0],
        area: ['90%', '90%'],
        iframe: {src: "{{url_for('upload_avatar')}}"},
      });
    });
    $(".default_avatar").click(function(){
      $("#avatar_user").attr("src",$(this).attr("src"));
      $("#avatar").attr("value",$(this).attr("src"));
    });
  });
</script>
<script type="text/javascript">
function update_avatar(data){
  $('#avatar_user').attr("src",data);
  $('#avatar').attr("value",data);
}
</script>
{% endblock %}